<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Branch WebSDK Test</title>
</head>
<body>

  <!-- Textarea to show SDK load/init status -->
  <textarea id="branchOutput"
            style="width:100%; height:120px; font-family:monospace;"
            readonly
            placeholder="Branch status will appear here…"></textarea>

  <!-- Paragraph to show browser name & version -->
  <p id="browserInfo" style="font-family:monospace; margin:8px 0;"></p>

  <p>
    <a href="https://timber.app.link/RsE3xtpXITb">Test SwiftUI App</a> |
    <a href="web+uwptestapp://" id="appLink">Open My App</a> |
    <a href="example.html">Load Example Page</a>
  </p>

  <button onclick="register()">Register Protocol Handler</button>

  <script>
    function register() {
      navigator.registerProtocolHandler(
        "web+uwptestapp",
        "https://nidhidixit09.github.io/loadApp.html?uri=%s",
        "UWPTestApp"
      );
    }
  </script>

  <!-- Branch Web SDK loader with onerror handler -->
  <script>
    (function(b,r,a,n,c,h,_,s,d,k){
      if (!b[n] || !b[n]._q) {
        for (; s < _.length; ) c(h, _[s++]);
        d = r.createElement(a);
        d.async = 1;
        d.src = "https://cdn.branch.io/branch-latest.min.js";

        // If the script fails to load (e.g. blocked), show an error
        d.onerror = function(evt) {
          var out = document.getElementById('branchOutput');
          out.value = '❌ Failed to load Branch SDK script:\n' +
                      (evt && evt.message ? evt.message : '(no message)');
        };

        k = r.getElementsByTagName(a)[0];
        k.parentNode.insertBefore(d, k);
        b[n] = h;
      }
    })(
      window,
      document,
      "script",
      "branch",
      function(b,r){ b[r] = function(){ b._q.push([r, arguments]); }; },
      { _q: [], _v: 1 },
      "addListener banner closeBanner closeJourney data deepview deepviewCta first init link logout removeListener setBranchViewData setIdentity track trackCommerceEvent logEvent disableTracking getBrowserFingerprintId crossPlatformIds lastAttributedTouchData setAPIResponseCallback qrCode setRequestMetaData setAPIUrl getAPIUrl setDMAParamsForEEA".split(" "),
      0
    );
  </script>

  <!-- Browser detection & Branch init -->
  <script>
    // Parse common browser names & versions from userAgent
    function getBrowserNameAndVersion() {
      var ua = navigator.userAgent, tem,
          M = ua.match(/(opera|opr|edg|edge|chrome|safari|firefox)\/?\s*(\d+(\.\d+)*)/i) || [];
      if (/trident/i.test(ua)) {
        tem = /\brv[ :]+(\d+)/g.exec(ua) || [];
        return { name: 'IE', version: (tem[1] || '') };
      }
      if (M[1]) {
        var name = M[1].toLowerCase();
        if (name === 'edg' || name === 'edge') name = 'Edge';
        else if (name === 'opr') name = 'Opera';
        else name = name.charAt(0).toUpperCase() + name.slice(1);
        return { name: name, version: M[2] };
      }
      // Fallback
      return { name: navigator.appName, version: navigator.appVersion };
    }

    // Write browser info into the page
    function displayBrowserInfo() {
      var info = getBrowserNameAndVersion();
      var el = document.getElementById('browserInfo');
      el.textContent = 'Browser: ' + info.name + ' v' + info.version;
    }

    // Wait for DOM + SDK load then initialize Branch
    function tryInitBranch() {
      displayBrowserInfo();

      if (!window.branch || !branch.init) {
        return setTimeout(tryInitBranch, 50);
      }

      branch.init('key_live_YOUR_KEY_GOES_HERE', function(err, data) {
        var out = document.getElementById('branchOutput');
        if (err) {
          out.value = '❌ Branch init error:\n' + JSON.stringify(err, null, 2);
        } else {
          var text = '✅ Branch init success:\n' + JSON.stringify(data, null, 2);
          if (data && data.data_parsed) {
            text += '\n\nDeep link data:\n' + JSON.stringify(data.data_parsed, null, 2);
          }
          out.value = text;
        }
      });
    }

    tryInitBranch();
  </script>

</body>
</html>

